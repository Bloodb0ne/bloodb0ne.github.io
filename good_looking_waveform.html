<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawing good looking Waveforms on the web - Treebound Science / Maybe everything can be expressed as a tree structure</title>
    <meta property="og:title" content="Drawing good looking Waveforms on the web">
    <meta property="og:site_name" content="Treebound Science / Maybe everything can be expressed as a tree structure">
    <meta property="og:url" content="http://bloodb0ne.github.io">
    <meta property="og:description" content="A small exploration for creating waveform vizualization on the web, simple and raw">
    <meta property="og:type" content="article">
    <meta property="og:image" content="http://bloodb0ne.github.io/images/article_waveform.png">

</head>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Roboto:wght@100;300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style/main.css">
<link rel="stylesheet" href="style/prism.css">
<script src="scripts/main.js"></script>

<script>
  

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-chtml-full.js">
</script>

    <header>
        <a href='index.html' class='logo'>
            <svg width="48" height="48" version="1.1" viewBox="0 0 12.7 12.7" xmlns="http://www.w3.org/2000/svg">
     <defs>
      <marker id="TriangleOutM" overflow="visible" orient="auto">
       <path transform="scale(.4)" d="m5.77 0-8.65 5v-10l8.65 5z" fill-rule="evenodd" stroke="#000" fill="#fff" stroke-width="1pt"/>
      </marker>
      <marker id="TriangleOutM-6" overflow="visible" orient="auto">
       <path transform="scale(.4)" d="m5.77 0-8.65 5v-10z" fill-rule="evenodd" stroke="#000" fill="#fff" stroke-width="1pt"/>
      </marker>
     </defs>
     <g transform="translate(0,-284.3)">
      <g transform="matrix(1.1658,0,0,1.0998,-1.2421,-31.948)" aria-label="⨁">
       <path d="m6.7634 288.2q-0.19162-0.0808-0.41061-0.0808t-0.41061 0.0808q-0.18751 0.0794-0.34354 0.23542-0.15877 0.15739-0.23678 0.34627-0.078015 0.18888-0.078015 0.41198 0 0.21762 0.078015 0.4065t0.23678 0.34627q0.15603 0.15603 0.34354 0.23542 0.19162 0.0808 0.41061 0.0808t0.41061-0.0808q0.18751-0.0794 0.34354-0.23542 0.15877-0.15739 0.23678-0.34627 0.078015-0.18888 0.078015-0.4065 0-0.2231-0.078015-0.41198t-0.23678-0.34627q-0.15603-0.15603-0.34354-0.23542zm-0.9266-0.22583q0.24363-0.10813 0.51599-0.10813 0.27237 0 0.50641 0.0985t0.4284 0.29153q0.19435 0.19435 0.29153 0.42977 0.095808 0.23267 0.095808 0.50778 0 0.26963-0.095808 0.50504-0.097177 0.23268-0.29153 0.42703-0.19435 0.19299-0.4284 0.29153-0.23405 0.0985-0.50641 0.0985-0.27237 0-0.50641-0.0985t-0.4284-0.29153q-0.19435-0.19435-0.29153-0.42703-0.095808-0.23541-0.095808-0.50504 0-0.27511 0.095808-0.50778 0.097177-0.23542 0.29153-0.42977 0.17519-0.17519 0.41882-0.28195zm0.63096 0.20941v0.89375h0.89375v0.23268h-0.89375v0.89375h-0.22994v-0.89375h-0.89375v-0.23268h0.89375v-0.89375z" stroke-width=".095559"/>
      </g>
      <g stroke="#000">
       <path d="m5.1869 288.39-1.7355 3.4286" fill="none" marker-end="url(#TriangleOutM)" stroke="#000" stroke-width=".34496px"/>
       <g fill="#ffffed">
        <g stroke-linecap="round" stroke-linejoin="round">
         <ellipse cx="2.0582" cy="294.97" rx="1.8798" ry="1.8235" stroke-width=".1544"/>
         <path transform="matrix(.26458 0 0 .26458 0 284.3)" d="m38.438 34.09a8.9193 6.8047 0 0 0-8.9199 6.8047 8.9193 6.8047 0 0 0 8.9199 6.8047 8.9193 6.8047 0 0 0 8.9199-6.8047 8.9193 6.8047 0 0 0-8.9199-6.8047zm0 0.95312a5.9082 3.2066 0 0 1 5.9082 3.2051 5.9082 3.2066 0 0 1-5.9082 3.207 5.9082 3.2066 0 0 1-5.9082-3.207 5.9082 3.2066 0 0 1 5.9082-3.2051z" stroke-width=".58356"/>
        </g>
        <g stroke-width=".1544">
         <path d="m0.62189 294.31c-0.5132 0.43858-0.44395 0.76825-0.44395 0.76825"/>
         <path d="m1.1964 294.67c-0.89579 0.69627-0.75961 1.2111-0.75961 1.2111"/>
         <path d="m1.0873 295.29c-0.56049 0.498-0.46195 0.84985-0.46195 0.84985"/>
         <path d="m1.3298 295.62c-0.51639 0.43521-0.44955 0.76533-0.44955 0.76533"/>
        </g>
        <g stroke-width=".10504">
         <path d="m1.4212 296.03c-0.32157 0.33236-0.28655 0.58341-0.28655 0.58341"/>
         <path d="m8.2267 295.25c-0.29782 0.35151-0.24546 0.59985-0.24546 0.59985"/>
         <path d="m8.8718 295.89c-0.29782 0.35151-0.24546 0.59985-0.24546 0.59985"/>
         <path d="m8.397 295.5c-0.29782 0.35148-0.24546 0.59985-0.24546 0.59985"/>
         <path d="m8.1301 294.98c-0.29782 0.35148-0.24546 0.59985-0.24546 0.59985"/>
         <path d="m8.5923 295.69c-0.29782 0.3515-0.24546 0.59985-0.24546 0.59985"/>
        </g>
        <path d="m8.9301 294.34c0.86746-0.69546 1.6021-0.53205 2.4696-0.0251" stroke-linecap="round" stroke-width=".77201"/>
        <path d="m1.0259 294.35c-0.89229 0.70025-0.75352 1.2144-0.75352 1.2144" stroke-width=".1544"/>
       </g>
       <path d="m7.0705 288.39 1.7355 3.4286" fill="none" marker-end="url(#TriangleOutM-6)" stroke-width=".34496px"/>
      </g>
     </g>
    </svg>
    
            </a>
            <div>
                <a href="https://twitter.com/emilianbr">
                    <svg version="1.1" id="White" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                        viewBox="0 0 400 400" style="enable-background:new 0 0 400 400;" xml:space="preserve">
                    <path class="st0" d="M400,200c0,110.5-89.5,200-200,200S0,310.5,0,200S89.5,0,200,0S400,89.5,400,200z M163.4,305.5
                        c88.7,0,137.2-73.5,137.2-137.2c0-2.1,0-4.2-0.1-6.2c9.4-6.8,17.6-15.3,24.1-25c-8.6,3.8-17.9,6.4-27.7,7.6
                        c10-6,17.6-15.4,21.2-26.7c-9.3,5.5-19.6,9.5-30.6,11.7c-8.8-9.4-21.3-15.2-35.2-15.2c-26.6,0-48.2,21.6-48.2,48.2
                        c0,3.8,0.4,7.5,1.3,11c-40.1-2-75.6-21.2-99.4-50.4c-4.1,7.1-6.5,15.4-6.5,24.2c0,16.7,8.5,31.5,21.5,40.1c-7.9-0.2-15.3-2.4-21.8-6
                        c0,0.2,0,0.4,0,0.6c0,23.4,16.6,42.8,38.7,47.3c-4,1.1-8.3,1.7-12.7,1.7c-3.1,0-6.1-0.3-9.1-0.9c6.1,19.2,23.9,33.1,45,33.5
                        c-16.5,12.9-37.3,20.6-59.9,20.6c-3.9,0-7.7-0.2-11.5-0.7C110.8,297.5,136.2,305.5,163.4,305.5"/>
                    </svg>
                </a>
                <a href="https://github.com/bloodb0ne">
                    <svg version="1.1" viewBox="0 0 11.493 11.209" xmlns="http://www.w3.org/2000/svg">
                    <g transform="translate(-45.658 -38.151)">
                    <path d="m51.404 38.151c-3.1729 0-5.746 2.5728-5.746 5.7468 0 2.5386 1.6464 4.6926 3.9299 5.4529 0.28751 0.05256 0.39229-0.12488 0.39229-0.27728 0-0.13652-0.0049-0.49777-0.0078-0.97719-1.5984 0.34713-1.9357-0.77047-1.9357-0.77047-0.26141-0.66393-0.63818-0.84067-0.63818-0.84067-0.52176-0.3563 0.03951-0.34925 0.03951-0.34925 0.57679 0.04057 0.88018 0.59231 0.88018 0.59231 0.51259 0.87806 1.3451 0.62442 1.6725 0.47731 0.05221-0.37112 0.20073-0.62442 0.36477-0.768-1.276-0.14534-2.6176-0.63818-2.6176-2.8402 0-0.62759 0.22401-1.1402 0.59161-1.542-0.05927-0.14534-0.25647-0.72954 0.05644-1.5208 0 0 0.48225-0.15452 1.5801 0.58879 0.45826-0.12735 0.95003-0.19085 1.4386-0.19332 0.48824 0.0025 0.97966 0.06597 1.4386 0.19332 1.0971-0.7433 1.5787-0.58879 1.5787-0.58879 0.31362 0.79128 0.11642 1.3755 0.0575 1.5208 0.3683 0.40181 0.59055 0.9144 0.59055 1.542 0 2.2077-1.3437 2.6935-2.6236 2.8356 0.20602 0.17745 0.38982 0.52811 0.38982 1.0643 0 0.768-0.0071 1.3878-0.0071 1.5762 0 0.15381 0.10372 0.33267 0.39511 0.27658 2.2818-0.76165 3.9268-2.9139 3.9268-5.4522 0-3.1739-2.5732-5.7468-5.7471-5.7468" fill="#1b1817" fill-rule="evenodd"/>
                    </g>
                    </svg>
                </a>
                <a href="rss.xml">
    <svg version="1.1" viewBox="0 0 60 60" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><path d="m41.164 42.268h5.104c0-14.633-11.904-26.545-26.535-26.545v5.09c11.814-1e-3 21.431 9.626 21.431 21.455zm-17.898 9e-3c1.957 0 3.538-1.572 3.538-3.521 0-1.938-1.581-3.528-3.538-3.528-1.949 0-3.533 1.59-3.533 3.528-1e-3 1.949 1.583 3.521 3.533 3.521zm8.877-7e-3h5.11c0-9.664-7.862-17.525-17.521-17.525v5.088c3.313 0 6.429 1.295 8.774 3.643 2.344 2.34 3.637 5.469 3.637 8.794zm-2.143 17.73c-16.568 0-30-13.432-30-30 0-16.569 13.432-30 30-30s30 13.431 30 30c0 16.568-13.432 30-30 30z" clip-rule="evenodd" fill="#010101" fill-rule="evenodd"/></svg>
                </a>
            </div>
    </header>    <main class="parent">
    <div class="sidebar box"></div>
    <div class="content box">
        <section id='title-section'>
            <h1>Drawing good looking Waveforms on the web</h1>
            <div class='datetime'><time datetime="2018-12-22T20:00:00.000Z">22 December 2018</time></div>
            <p>A small exploration for creating waveform vizualization on the web, simple and raw</p>
        </section>
    <p>After starting a small project that had and audio component i wanted to show some representation of it. So how do you visualize audio ?
Decided to look at products that have any sort of audio visualizations and found 2 distinct types of looks:</p>
<p>Well doesn’t seem like a complex task so what about libraries that help us achieve the task at hand. The Soundcloud is really stylized and also a web solution, but searching for what are they using i stumbled on Waveform.js (). Now at first hand its an easy to use solution and even supports streaming waveform data only one thing doesnt seem right</p>
<p>Well it seems like Soundcloud is not using it anymore so how do we really replicate the same type of audio visualization. One interesting note here is that they made an article about that some years age showing the aforementioned library.
First thing thats important to be aware that our audio file contains alot of samples. For my specific purpose i had audio with length between 1 hours and a maximum of 24 hours so that is probably too big to use all the samples for the visualizations.
So next thing we have to do is decide what samples are we gonna leave and what samples we want do discard, but keep the shape of the waveform almost intact. We can use some audio specific technique for downsampling, but if we are not really thinking about accuracy a simple selection of the maximum value is enough.</p>
<p>Getting Samples
One of the best tools to get the audio samples from either video or some audio container format is ffmpeg. I know that there are more capable tools specific for audio format manipulation, but this will do the job for now.
ffmpeg -i &lt;audio/video_file&gt; -ac 1 -ar 44100 -c:a pcm_s16le -f s16le pipe:
ac allows us to choose how many channels we want
ar is the sample rate of our output, should be the same as the input file
the other options -c:a pcm_s16le -f s16le define how the output will be formatted
We chose to use pcm format because its just raw samples no headers no extra metadata.
Choosing a proper format of what you want to parse is essential, in this case I use signed 16-bit Little Endian. All the other formats you can see here <a href=https://trac.ffmpeg.org/wiki/audio%20types alt=undefined>https://trac.ffmpeg.org/wiki/audio%20types</a>. After we have the proper format we just need to parse it in parts because there is no need to save the whole file.</p>
<p><a href=https://gist.github.com/Bloodb0ne/706254db1f7b5baabf6cb86f0142f939#file-test_pcm-js alt=undefined>https://gist.github.com/Bloodb0ne/706254db1f7b5baabf6cb86f0142f939#file-test_pcm-js</a></p>
<p>This is a sample snippet in Node.js to fetch and reduce the samples from a spawned ffmpeg process. First we estimate the amount of samples we get from a file with a certain size based on sample rate and duration of the audio. Using this size we can now fill a bucket with samples and get the maximum value for each bucket and that will be our final output sample.
Now that we have our final result of 1800 samples of audio its time to display them. Using <canvas> would allow us to really easy render and modify the data.
From now on we have the simple task to draw a weighted line for each sample, but because of being in the browser and resizing we can pick which samples we draw.
First off we clear the canvas and then save the context so we don’t contaminate the canvas drawing environment.
Now for each pixel in the canvas we decide what sample to draw and what gap to leave between each drawn sample using the barWidth and gapWidth variables. Each sample that we draw is represented by a rectangle that has an X value dependent on the position of the sample and an Y value dependent on the value of the sample.
First of we get our sample at index
((k / d) * r) | 0
where k is our current position, d is our canvas width and r is the amount of samples in our waveform. Because we have small values for the indexes we can round it using a bitwise operator ( | ) and not with Math.round().
After we get our sample value and we scale it in the [0,1] range we can use it to determine the maxY and minY value for the rectangle.
T = (C * g) | 0;
S = ((1 — C ) * v + g) | 0;
Another important thing that’s specific about the style and aesthetic of the Soundcloud visualization is that there is a line used for the “center” of the sample. I separates the rectangle into two halfs thats specified with the linePercent option. In this example its placed at 70% of the height of the waveform.
The minY value or T is calculated by simply multiplying the value of the sample to the size of the upper half above the waveform above the separating line.
The maxY value or S is calculated by getting the inverse sample multiplying it by the lower half below the waveform and adding the height of the upper half.
Having calculated maxY and minY we now have the height of our rectangle by just subtracting the two values.
c.rect( k,T,gw,S-T);
Each gap is positioned after our sample and uses the already calculated values of the previous sample so it aligns with the last drawn rectangle.
A = Math.max(T, w)
c.fillRect(k — gapWidth,A,gapWidth,Math.min(S,x) — A)
Finally to create a nice effect we fill the already created path with a gradient with a sharp stop at the separating line. Creating a sharp stop is accomplished with adding another colorStop to our gradient with the same position.
After drawing all rectangles of the waveform we just draw a single pixel line with a rectangle to create a clear distinction between the upper and lower half of the waveform.
c.clearRect(0,g,d,1)</p>
<p>Bonus( coloring a region of the waveform)
In the example code below we have the function drawOverlay that just draws a rectangle over our waveform but we use a composition operation “source-atop” so we use the waveform as a mask. You can learn more on composition operation on the MDN ( <a href=https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/globalCompositeOperation alt=undefined>https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/globalCompositeOperation</a> ).</p>
<p><a href=https://gist.github.com/Bloodb0ne/419c5314b691816b20ecd74554b28c3b#file-waveform-html alt=undefined>https://gist.github.com/Bloodb0ne/419c5314b691816b20ecd74554b28c3b#file-waveform-html</a></p>

    </div>
    <aside class='box'>
        <nav class="toc" offset="80" aria-label="local navigation" >
            <h3>Contents</h3>
            <ul>
            </ul>
        </nav>
    </aside>
</main>
</body>
</html>